<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flight History - Marc</title>
    <meta name="description"
        content="Interactive flight history tracker with map visualization, statistics, and PDF export. Marc's personal flight log.">
    <meta property="og:title" content="Flight History - Marc">
    <meta property="og:description" content="Interactive flight history map with statistics and route visualization.">
    <meta property="og:type" content="website">
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>✈️</text></svg>">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- PapaParse -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Google Fonts (Inter & Roboto Mono) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- Iconos (Phosphor) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Local Airport Database (4500+ airports) -->
    <script src="js/airports.js"></script>

    <!-- Chart.js for statistics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- PDF Export libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Leaflet heatmap for density visualization -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.heat/0.2.0/leaflet-heat.js"></script>

    <style>
        :root {
            --bg-primary: #000000;
            --bg-secondary: #1C1C1E;
            --bg-card: #2C2C2E;
            --bg-card-hover: #3A3A3C;
            --text-primary: #ffffff;
            --text-secondary: #9CA3AF;
            --text-muted: #6B7280;
            --border-color: #2C2C2E;
            --accent: #3b82f6;
        }

        body.light {
            --bg-primary: #F2F2F7;
            --bg-secondary: #FFFFFF;
            --bg-card: #FFFFFF;
            --bg-card-hover: #F3F4F6;
            --text-primary: #000000;
            --text-secondary: #6B7280;
            --text-muted: #9CA3AF;
            --border-color: #E5E7EB;
            --accent: #007AFF;
        }

        body {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Light mode overrides for hardcoded colors */
        body.light .bg-\[\#000000\],
        body.light .bg-\[\#000000\]\/50 {
            background-color: var(--bg-primary) !important;
        }

        body.light .bg-\[\#1C1C1E\],
        body.light .bg-\[\#1C1C1E\]\/50 {
            background-color: var(--bg-secondary) !important;
        }

        body.light .bg-\[\#2C2C2E\],
        body.light .bg-\[\#3A3A3C\] {
            background-color: var(--bg-card) !important;
        }

        body.light .text-white {
            color: var(--text-primary) !important;
        }

        body.light .text-gray-400,
        body.light .text-gray-500 {
            color: var(--text-secondary) !important;
        }

        body.light .border-\[\#2C2C2E\] {
            border-color: var(--border-color) !important;
        }

        body.light .flight-card {
            background-color: var(--bg-card) !important;
            border-color: var(--border-color) !important;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        body.light .flight-card.active {
            border-color: var(--accent) !important;
            background-color: rgba(59, 130, 246, 0.1) !important;
        }

        /* Light mode Reset button */
        body.light #resetBtn {
            background: rgba(255, 255, 255, 0.9) !important;
            color: #1C1C1E !important;
            border-color: rgba(0, 0, 0, 0.1) !important;
        }

        body.light #resetBtn:hover {
            background: rgba(255, 255, 255, 1) !important;
        }

        body.light #resetBtn span,
        body.light #resetBtn i {
            color: #1C1C1E !important;
        }

        /* Light mode Play button */
        body.light #playAnimationBtn {
            background: rgba(255, 255, 255, 0.9) !important;
            border-color: rgba(0, 0, 0, 0.1) !important;
        }

        body.light #playAnimationBtn:hover {
            background: rgba(255, 255, 255, 1) !important;
        }

        body.light #playAnimationBtn i {
            color: #DC2626 !important;
        }

        /* Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Tarjetas */
        .flight-card {
            transition: all 0.2s ease;
        }

        .flight-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }

        .flight-card.active {
            border-color: #3b82f6;
            background-color: #1e293b;
        }

        /* Font Mono override */
        .font-mono {
            font-family: 'Roboto Mono', monospace;
        }

        /* Map Customization */
        .leaflet-container {
            background: #000000 !important;
        }

        body.light .leaflet-container {
            background: #E8E8ED !important;
        }

        /* Unified zoom control - single rounded pill */
        .leaflet-control-zoom {
            border: none !important;
            border-radius: 24px !important;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
            background: rgba(44, 44, 46, 0.8) !important;
            backdrop-filter: blur(20px) !important;
            -webkit-backdrop-filter: blur(20px) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        .leaflet-control-zoom a {
            background-color: transparent !important;
            color: rgba(255, 255, 255, 0.8) !important;
            border: none !important;
            border-radius: 0 !important;
            width: 40px !important;
            height: 40px !important;
            line-height: 40px !important;
            font-size: 18px !important;
            font-weight: 400 !important;
        }

        .leaflet-control-zoom a:hover {
            background-color: rgba(255, 255, 255, 0.1) !important;
            color: white !important;
        }

        .leaflet-control-zoom-in {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        /* Light mode zoom controls */
        body.light .leaflet-control-zoom {
            background: rgba(255, 255, 255, 0.9) !important;
            border: 1px solid rgba(0, 0, 0, 0.1) !important;
        }

        body.light .leaflet-control-zoom a {
            color: rgba(0, 0, 0, 0.7) !important;
        }

        body.light .leaflet-control-zoom a:hover {
            background-color: rgba(0, 0, 0, 0.05) !important;
            color: black !important;
        }

        body.light .leaflet-control-zoom-in {
            border-bottom: 1px solid rgba(0, 0, 0, 0.1) !important;
        }

        /* Apple-style Layer Control */
        .leaflet-control-layers {
            background: rgba(44, 44, 46, 0.9) !important;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            border-radius: 16px !important;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4) !important;
            padding: 0 !important;
            overflow: hidden;
        }

        .leaflet-control-layers-toggle {
            background-color: transparent !important;
            width: 40px !important;
            height: 40px !important;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='white' viewBox='0 0 256 256'%3E%3Cpath d='M220,169.09l-92,53.65L36,169.09a8,8,0,0,0-8,13.82l96,56a8,8,0,0,0,8.06,0l96-56a8,8,0,1,0-8.06-13.82Z'/%3E%3Cpath d='M220,121.09l-92,53.65L36,121.09a8,8,0,0,0-8,13.82l96,56a8,8,0,0,0,8.06,0l96-56a8,8,0,1,0-8.06-13.82Z'/%3E%3Cpath d='M28,86.91l96,56a8,8,0,0,0,8.06,0l96-56a8,8,0,0,0,0-13.82l-96-56a8,8,0,0,0-8.06,0l-96,56a8,8,0,0,0,0,13.82Z'/%3E%3C/svg%3E") !important;
            background-size: 20px 20px !important;
            background-position: center !important;
            background-repeat: no-repeat !important;
        }

        .leaflet-control-layers-expanded {
            padding: 12px !important;
        }

        .leaflet-control-layers-list {
            color: white !important;
        }

        .leaflet-control-layers label {
            color: white !important;
            font-size: 13px !important;
            font-weight: 500 !important;
            padding: 6px 8px !important;
            border-radius: 8px !important;
            margin: 2px 0 !important;
            display: block !important;
            transition: background 0.2s ease !important;
        }

        .leaflet-control-layers label:hover {
            background: rgba(255, 255, 255, 0.1) !important;
        }

        .leaflet-control-layers-separator {
            display: none !important;
        }

        /* Light mode layer control */
        body.light .leaflet-control-layers {
            background: rgba(255, 255, 255, 0.95) !important;
            border: 1px solid rgba(0, 0, 0, 0.1) !important;
        }

        body.light .leaflet-control-layers-toggle {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%231C1C1E' viewBox='0 0 256 256'%3E%3Cpath d='M220,169.09l-92,53.65L36,169.09a8,8,0,0,0-8,13.82l96,56a8,8,0,0,0,8.06,0l96-56a8,8,0,1,0-8.06-13.82Z'/%3E%3Cpath d='M220,121.09l-92,53.65L36,121.09a8,8,0,0,0-8,13.82l96,56a8,8,0,0,0,8.06,0l96-56a8,8,0,1,0-8.06-13.82Z'/%3E%3Cpath d='M28,86.91l96,56a8,8,0,0,0,8.06,0l96-56a8,8,0,0,0,0-13.82l-96-56a8,8,0,0,0-8.06,0l-96,56a8,8,0,0,0,0,13.82Z'/%3E%3C/svg%3E") !important;
        }

        body.light .leaflet-control-layers-list {
            color: #1C1C1E !important;
        }

        body.light .leaflet-control-layers label {
            color: #1C1C1E !important;
        }

        body.light .leaflet-control-layers label:hover {
            background: rgba(0, 0, 0, 0.05) !important;
        }

        /* Airport Label Styles - Auto-sizing */
        .airport-label {
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 5px 10px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            font-family: 'Inter', sans-serif;
            border: 1px solid rgba(255, 255, 255, 0.2);
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        /* Distance Tooltip on Route Hover */
        .distance-tooltip {
            background: rgba(30, 110, 244, 0.9) !important;
            color: white !important;
            padding: 4px 10px !important;
            border-radius: 12px !important;
            font-size: 11px !important;
            font-weight: 600 !important;
            font-family: 'Inter', sans-serif !important;
            border: none !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3) !important;
        }

        .distance-tooltip::before {
            display: none !important;
        }

        /* Plane Animation */
        @keyframes flyAcross {
            0% {
                left: 10%;
                opacity: 0;
            }

            5% {
                opacity: 1;
            }

            95% {
                opacity: 1;
            }

            100% {
                left: 90%;
                opacity: 0;
            }
        }

        .fly-icon {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%) rotate(90deg);
            animation: flyAcross 4s linear infinite;
        }
    </style>
</head>

<body class="dark">

    <!-- Main Container -->
    <div class="flex h-screen w-full relative">

        <!-- Map Container -->
        <div id="globeContainer"
            class="flex-1 relative bg-black transition-colors duration-500 overflow-hidden h-full w-full">
            <div id="mapViz" class="w-full h-full" style="min-height: 100vh;"></div>

            <!-- Reset Camera Button (Apple Style - Theme Aware) -->
            <button id="resetBtn" onclick="resetCamera()"
                class="absolute bottom-8 left-8 bg-[#2C2C2E]/80 backdrop-blur-xl px-4 py-2.5 rounded-full shadow-lg text-white hover:bg-[#3A3A3C] transition-all border border-white/10 z-[999] flex items-center gap-2 group">
                <i class="ph-bold ph-arrows-out-cardinal text-lg group-hover:scale-110 transition-transform"></i>
                <span class="text-sm font-semibold">Reset</span>
            </button>

            <!-- Play Animation Button -->
            <button id="playAnimationBtn" onclick="playAllFlightsAnimation()"
                class="absolute bottom-8 left-36 bg-[#2C2C2E]/80 backdrop-blur-xl px-4 py-2.5 rounded-full shadow-lg text-red-400 hover:text-red-300 hover:bg-[#3A3A3C] transition-all border border-white/10 z-[999] flex items-center gap-2 group"
                title="Reproducir todos los vuelos">
                <i class="ph-bold ph-play text-lg group-hover:scale-110 transition-transform"></i>
            </button>
        </div>

        <!-- Sidebar (Right) -->
        <div
            class="w-[500px] min-w-[450px] max-w-[600px] flex-shrink-0 bg-[#000000] border-l border-[#2C2C2E] flex flex-col shadow-2xl z-20 transition-colors duration-500 text-white">

            <!-- Header -->
            <div class="p-6 border-b border-[#2C2C2E] bg-[#000000]/50 backdrop-blur-md z-10">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h1 class="text-2xl font-black mb-1 tracking-tight text-white">Vuelos</h1>
                        <div class="w-[145px] h-[2px] bg-[#FF0000] mb-1"></div>
                        <p class="text-sm text-gray-400 font-medium">Marc's Flight History</p>
                    </div>
                    <div class="flex gap-2">
                        <input type="file" id="csvInput" accept=".csv" class="hidden"
                            onchange="handleFileUpload(event)">
                        <button onclick="document.getElementById('csvInput').click()"
                            class="w-10 h-10 flex items-center justify-center rounded-full bg-[#1C1C1E] text-gray-400 hover:bg-[#2C2C2E] transition-colors shadow-sm cursor-pointer"
                            title="Subir CSV">
                            <i class="ph-bold ph-upload-simple text-lg"></i>
                        </button>
                        <button onclick="toggleStats()"
                            class="w-10 h-10 flex items-center justify-center rounded-full bg-[#1C1C1E] text-gray-400 hover:bg-[#2C2C2E] transition-colors shadow-sm cursor-pointer"
                            title="Ver Estadísticas">
                            <i class="ph-bold ph-chart-bar text-lg"></i>
                        </button>
                        <button onclick="exportPDF()"
                            class="w-10 h-10 flex items-center justify-center rounded-full bg-[#1C1C1E] text-gray-400 hover:bg-[#2C2C2E] transition-colors shadow-sm cursor-pointer"
                            title="Exportar PDF">
                            <i class="ph-bold ph-file-pdf text-lg"></i>
                        </button>
                        <button id="themeToggle" onclick="toggleTheme()"
                            class="w-10 h-10 flex items-center justify-center rounded-full bg-[#1C1C1E] text-gray-400 hover:bg-[#2C2C2E] transition-colors shadow-sm cursor-pointer"
                            title="Cambiar Tema">
                            <i class="ph-bold ph-moon text-lg" id="themeIcon"></i>
                        </button>
                    </div>
                </div>

                <!-- Mini Stats -->
                <div class="flex gap-4 mb-4 justify-between">
                    <div class="flex-1 text-center">
                        <div class="text-xl font-black text-white whitespace-nowrap" id="totalFlights">-</div>
                        <div class="text-[10px] uppercase font-bold text-gray-500 tracking-wider">
                            Vuelos</div>
                    </div>
                    <div class="flex-1 text-center">
                        <div class="text-xl font-black text-white whitespace-nowrap" id="totalHours">-</div>
                        <div class="text-[10px] uppercase font-bold text-gray-500 tracking-wider">
                            Horas</div>
                    </div>
                    <div class="flex-1 text-center">
                        <div class="text-xl font-black text-white whitespace-nowrap" id="totalDistance">-</div>
                        <div class="text-[10px] uppercase font-bold text-gray-500 tracking-wider">
                            Distancia</div>
                    </div>
                    <div class="flex-1 text-center">
                        <div class="text-xl font-black text-white whitespace-nowrap" id="totalCO2">-</div>
                        <div class="text-[10px] uppercase font-bold text-gray-500 tracking-wider">
                            CO₂</div>
                    </div>
                </div>

                <!-- Year Filter -->
                <div class="relative w-full group">
                    <select id="yearFilter" onchange="filterByYear(true)"
                        class="w-full appearance-none bg-[#2C2C2E] text-gray-300 text-xs font-bold py-2.5 px-4 rounded-lg border border-transparent focus:border-blue-500 outline-none cursor-pointer transition-colors hover:bg-[#3A3A3C]">
                        <option value="all">Todos los años</option>
                    </select>
                    <i
                        class="ph-bold ph-caret-down absolute right-3 top-3 text-slate-400 pointer-events-none group-hover:text-slate-600 transition-colors"></i>
                </div>

                <!-- Search Input -->
                <div class="relative mt-2">
                    <input type="text" id="searchInput" placeholder="Buscar vuelos..." oninput="applySearch()"
                        class="w-full bg-[#2C2C2E] text-gray-300 text-xs py-2.5 pl-9 pr-4 rounded-lg border border-transparent focus:border-blue-500 outline-none transition-colors hover:bg-[#3A3A3C] placeholder-gray-500">
                    <i class="ph-bold ph-magnifying-glass absolute left-3 top-2.5 text-gray-500"></i>
                </div>

                <!-- Sort Selector -->
                <div class="relative w-full mt-2 group">
                    <select id="sortSelector" onchange="applySort()"
                        class="w-full appearance-none bg-[#2C2C2E] text-gray-300 text-xs py-2.5 px-4 rounded-lg border border-transparent focus:border-blue-500 outline-none cursor-pointer transition-colors hover:bg-[#3A3A3C]">
                        <option value="date-desc">Fecha (reciente)</option>
                        <option value="date-asc">Fecha (antigua)</option>
                        <option value="duration-desc">Duración (larga)</option>
                        <option value="duration-asc">Duración (corta)</option>
                        <option value="distance-desc">Distancia (larga)</option>
                        <option value="distance-asc">Distancia (corta)</option>
                    </select>
                    <i
                        class="ph-bold ph-sort-ascending absolute right-3 top-2.5 text-slate-400 pointer-events-none"></i>
                </div>

                <!-- Advanced Filters Toggle -->
                <div class="mt-2">
                    <button onclick="toggleFiltersPanel()" id="filterToggleBtn"
                        class="w-full flex items-center justify-between bg-[#2C2C2E] text-gray-400 text-xs font-medium py-2 px-3 rounded-lg hover:bg-[#3A3A3C] transition-colors">
                        <span class="flex items-center gap-2">
                            <i class="ph-bold ph-funnel"></i>
                            <span>Filtros avanzados</span>
                        </span>
                        <i class="ph-bold ph-caret-down transition-transform" id="filterArrow"></i>
                    </button>

                    <div id="filtersPanel" class="hidden mt-2 space-y-2">
                        <select id="airlineFilter" onchange="applyAdvancedFilters()"
                            class="w-full appearance-none bg-[#3A3A3C] text-gray-300 text-xs py-2 px-3 rounded-lg outline-none cursor-pointer">
                            <option value="all">Todas las aerolíneas</option>
                        </select>
                        <select id="aircraftFilter" onchange="applyAdvancedFilters()"
                            class="w-full appearance-none bg-[#3A3A3C] text-gray-300 text-xs py-2 px-3 rounded-lg outline-none cursor-pointer">
                            <option value="all">Todos los aviones</option>
                        </select>
                        <select id="countryFilter" onchange="applyAdvancedFilters()"
                            class="w-full appearance-none bg-[#3A3A3C] text-gray-300 text-xs py-2 px-3 rounded-lg outline-none cursor-pointer">
                            <option value="all">Todos los países</option>
                        </select>
                        <button onclick="clearFilters()"
                            class="w-full text-xs text-gray-500 hover:text-gray-300 py-1 transition-colors">
                            <i class="ph-bold ph-x-circle mr-1"></i>Limpiar filtros
                        </button>
                    </div>
                </div>
            </div>

            <!-- List -->
            <div id="flightList" class="flex-1 overflow-y-auto p-4 content-start pb-20 custom-scrollbar">
                <!-- Cards injected JS -->
            </div>
        </div>
    </div>

    <!-- Stats Modal (Hidden by default) -->
    <div id="statsModal"
        class="fixed inset-0 z-[9999] hidden transition-opacity duration-300 opacity-0 pointer-events-none">
        <div class="absolute inset-0 bg-black/80" onclick="toggleStats()"></div>
        <div id="statsContent"
            class="absolute inset-4 md:inset-auto md:top-[5%] md:bottom-[5%] md:left-1/2 md:-translate-x-1/2 md:w-[600px] bg-[#1C1C1E] rounded-3xl shadow-2xl overflow-hidden flex flex-col border border-white/10 text-white z-10">

            <div
                class="p-6 border-b border-[#2C2C2E] flex justify-between items-center bg-[#1C1C1E]/50 backdrop-blur-md sticky top-0 z-10">
                <div>
                    <h2 class="text-2xl font-black text-white tracking-tight">Estadísticas</h2>
                    <p class="text-sm text-gray-400 font-medium">Análisis detallado</p>
                </div>
                <button onclick="toggleStats()"
                    class="w-8 h-8 flex items-center justify-center rounded-full bg-[#2C2C2E] text-gray-400 hover:bg-[#3A3A3C] transition-colors">
                    <i class="ph-bold ph-x"></i>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto p-6 space-y-6 custom-scrollbar">
                <!-- KPI Grid -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-[#2C2C2E] p-4 rounded-2xl border border-[#3A3A3C]">
                        <div class="text-gray-500 text-xs font-bold uppercase tracking-wider mb-1">Vuelos</div>
                        <div class="text-3xl font-black text-white" id="modalTotalFlights">-</div>
                    </div>
                    <div class="bg-[#2C2C2E] p-4 rounded-2xl border border-[#3A3A3C]">
                        <div class="text-gray-500 text-xs font-bold uppercase tracking-wider mb-1">Tiempo</div>
                        <div class="text-3xl font-black text-white" id="modalTotalTime">-</div>
                    </div>
                </div>

                <!-- Top Stats Grid -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Top Aerolíneas</h3>
                        <div id="airlineStats" class="space-y-2"></div>
                    </div>
                    <div>
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Top Aeronaves</h3>
                        <div id="aircraftStats" class="space-y-2"></div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Top Aeropuertos</h3>
                        <div id="airportStats" class="space-y-2"></div>
                    </div>
                    <div>
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Top Países</h3>
                        <div id="countryStats" class="space-y-2"></div>
                    </div>
                </div>

                <div>
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Top Rutas</h3>
                    <div id="routeStats" class="space-y-2"></div>
                </div>

                <!-- New: Seat Type & Flight Reason -->
                <div class="grid grid-cols-2 gap-4 pt-4 border-t border-[#2C2C2E]">
                    <div>
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Tipo de Asiento</h3>
                        <div id="seatTypeStats" class="space-y-2"></div>
                    </div>
                    <div>
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Motivo de Viaje</h3>
                        <div id="flightReasonStats" class="space-y-2"></div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="space-y-6 pt-4 border-t border-[#2C2C2E]">
                    <div>
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Vuelos por Año</h3>
                        <div class="bg-[#2C2C2E] p-4 rounded-2xl"><canvas id="chartYear" height="120"></canvas></div>
                    </div>
                    <div>
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Vuelos por Mes</h3>
                        <div class="bg-[#2C2C2E] p-4 rounded-2xl"><canvas id="chartMonth" height="120"></canvas></div>
                    </div>
                    <div>
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Vuelos por Día</h3>
                        <div class="bg-[#2C2C2E] p-4 rounded-2xl"><canvas id="chartDay" height="120"></canvas></div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- SCRIPTS -->
    <script>
        // Data Fallback
        let airports = {
            'BCN': { lat: 41.2974, lng: 2.0833, city: "Barcelona", country: "ES", name: "El Prat" },
            'TFN': { lat: 28.4827, lng: -16.3415, city: "Tenerife-Norte", country: "ES", name: "Los Rodeos" },
            'MUC': { lat: 48.3537, lng: 11.7750, city: "Munich", country: "DE", name: "Franz Josef Strauss" },
            // ... (rest will be loaded)
        };

        async function loadAirportDB() {
            // Priority: Local DB (Bypass CORS/Offline issues)
            if (window.AIRPORT_DB) {
                Object.assign(airports, window.AIRPORT_DB);
                console.log("Local Airport DB loaded (Pre-loaded).");
            }

            try {
                const response = await fetch('https://raw.githubusercontent.com/mwgg/Airports/master/airports.json');
                if (!response.ok) throw new Error("Failed to fetch airports");
                const data = await response.json();

                for (const [code, details] of Object.entries(data)) {
                    if (!airports[code]) {
                        airports[code] = {
                            lat: details.lat,
                            lng: details.lon,
                            city: details.city,
                            country: details.country,
                            name: details.name.split('Airport')[0].trim() || details.city
                        };
                    }
                }
                console.log("Extended Airport DB loaded.");
            } catch (e) {
                console.warn("Could not load extended airport DB (CORS/Offline). Using local fallback.", e);
            }
        }

        let flights = [];
        let map;
        let flightLines = [];
        let markers = [];
        let currentYearFilter = 'all';
        let selectedFlight = null;
        let hoveredFlight = null;
        let isDarkMode = true;
        let animatedPlane = null;
        let planeAnimationId = null;

        const listContainer = document.getElementById('flightList');

        // Main Init
        window.onload = async () => {
            initTheme(); // Initialize theme from localStorage
            await loadAirportDB();
            await loadData();
            initMap();
        }


        async function loadData() {
            showLoading();
            return new Promise((resolve, reject) => {
                Papa.parse("flightdiary.csv", {
                    download: true,
                    header: true,
                    skipEmptyLines: true,
                    encoding: "ISO-8859-1",
                    complete: function (results) {
                        processFlightData(results);
                        resolve();
                    },
                    error: function (err) {
                        console.error("Papa Parse Error:", err);
                        showError("Error al cargar datos. Verifica la console.");
                        reject(err);
                    }
                });
            });
        }

        function initMap() {
            if (map) return;

            // More reliable tile layers
            const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© OpenStreetMap'
            });

            const darkLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                subdomains: 'abcd',
                maxZoom: 19,
                attribution: '© CartoDB'
            });

            const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '© Esri',
                maxZoom: 18
            });

            // Topographic layer (OpenTopoMap)
            const topoLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                maxZoom: 17,
                attribution: '© OpenTopoMap'
            });

            // Hybrid layer (Satellite + Labels)
            const hybridLabels = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}', {
                maxZoom: 18,
                attribution: '© Esri'
            });
            const hybridLayer = L.layerGroup([satelliteLayer, hybridLabels]);

            // Init with Dark (most reliable + looks good)
            map = L.map('mapViz', {
                center: [30, 0],
                zoom: 2,
                zoomControl: false,
                attributionControl: false,
                layers: [darkLayer]
            });

            // Layer switcher
            const baseMaps = {
                "Oscuro": darkLayer,
                "Satelite": satelliteLayer,
                "Hibrido": hybridLayer,
                "Topografico": topoLayer,
                "Estandar": osmLayer
            };
            L.control.layers(baseMaps, null, { position: 'topright' }).addTo(map);
            L.control.zoom({ position: 'bottomright' }).addTo(map);

            updateMapVisuals();
            renderUI();
            calculateStats();
        }

        function updateMapVisuals() {
            if (!map) return;

            // Clear Layers
            flightLines.forEach(l => map.removeLayer(l));
            markers.forEach(m => map.removeLayer(m));
            flightLines = [];
            markers = [];

            const filtered = getFilteredFlights();

            // Draw Flight Paths (Lines)
            filtered.forEach(f => {
                const start = airports[f.from];
                const end = airports[f.to];
                if (!start || !end) return;

                const isSelected = selectedFlight && selectedFlight.id === f.id;
                const isHovered = hoveredFlight && hoveredFlight.id === f.id;
                const isActive = isSelected || isHovered;

                // Style Colors from User Request
                const color = isActive ? '#1E6EF4' : '#5CB8FF';
                const weight = isActive ? 3 : 1;
                const opacity = isActive ? 1.0 : 0.4;

                // Generate curved arc points (Great Circle approximation)
                const generateArcPoints = (start, end, numPoints = 50) => {
                    const points = [];
                    for (let i = 0; i <= numPoints; i++) {
                        const t = i / numPoints;
                        // Interpolate latitude
                        const lat = start.lat + t * (end.lat - start.lat);
                        // Interpolate longitude (handle date line crossing)
                        let lngDiff = end.lng - start.lng;
                        if (Math.abs(lngDiff) > 180) {
                            lngDiff = lngDiff > 0 ? lngDiff - 360 : lngDiff + 360;
                        }
                        const lng = start.lng + t * lngDiff;
                        // Add curvature - bend towards pole for realistic great circle effect
                        const curveFactor = Math.sin(t * Math.PI) * 0.15;
                        const midLat = (start.lat + end.lat) / 2;
                        const curveOffset = curveFactor * Math.abs(lngDiff) * (midLat > 0 ? 1 : -1) * 0.3;
                        points.push([lat + curveOffset, lng]);
                    }
                    return points;
                };

                const arcPoints = generateArcPoints(start, end);
                const line = L.polyline(arcPoints, {
                    color: color,
                    weight: weight,
                    opacity: opacity,
                    smoothFactor: 1
                }).addTo(map);

                // Add distance tooltip on hover
                line.bindTooltip(`${Math.round(f.distance).toLocaleString()} km`, {
                    sticky: true,
                    className: 'distance-tooltip'
                });

                line.on('click', () => {
                    handleFlightSelection(f);
                });

                flightLines.push(line);
            });

            // Draw Airports (Dots) based on filtered flights
            const uniqueCodes = [...new Set([...filtered.map(f => f.from), ...filtered.map(f => f.to)])];

            // City name corrections for better display
            const cityNameCorrections = {
                'ACE': 'Lanzarote',
                'TFS': 'Tenerife',
                'TFN': 'Tenerife',
                'MXP': 'Milan',
                'LIN': 'Milan',
                'BGY': 'Milan',
                'FCO': 'Rome',
                'CIA': 'Rome',
                'LGW': 'London',
                'LHR': 'London',
                'STN': 'London',
                'LTN': 'London',
                'LCY': 'London',
                'JFK': 'New York',
                'LGA': 'New York',
                'EWR': 'New York',
                'ORY': 'Paris',
                'CDG': 'Paris',
                'SFO': 'San Francisco',
                'OAK': 'San Francisco',
                'SJC': 'San Francisco',
                'LAX': 'Los Angeles',
                'FLL': 'Fort Lauderdale'
            };

            function getCityName(code, airport) {
                return cityNameCorrections[code] || airport.city || code;
            }

            // Calculate airport visit frequency for variable marker sizes
            const airportFrequency = {};
            filtered.forEach(f => {
                airportFrequency[f.from] = (airportFrequency[f.from] || 0) + 1;
                airportFrequency[f.to] = (airportFrequency[f.to] || 0) + 1;
            });
            const maxFreq = Math.max(...Object.values(airportFrequency), 1);

            uniqueCodes.forEach(code => {
                const a = airports[code];
                if (!a) return;

                // Variable radius: 3.5px (1 visit) to 7px (max visits)
                const freq = airportFrequency[code] || 1;
                const radius = 3.5 + (freq / maxFreq) * 3.5;

                const circle = L.circleMarker([a.lat, a.lng], {
                    radius: radius,
                    fillColor: 'rgb(233, 21, 45)', // Custom Red
                    color: '#000',
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 1
                }).addTo(map);

                const displayCity = getCityName(code, a);
                circle.bindTooltip(`${displayCity} (${code})`, {
                    direction: 'top',
                    className: 'airport-label'
                });

                // Show permanent label for selected/hovered flight airports
                const isSelectedAirport = selectedFlight && (selectedFlight.from === code || selectedFlight.to === code);
                const isHoveredAirport = hoveredFlight && (hoveredFlight.from === code || hoveredFlight.to === code);

                if (isSelectedAirport || isHoveredAirport) {
                    const label = L.marker([a.lat, a.lng], {
                        icon: L.divIcon({
                            className: 'airport-label',
                            html: `${displayCity} <span style="opacity:0.6">(${code})</span>`,
                            iconSize: null, // Auto-size based on content
                            iconAnchor: [-8, 10]
                        })
                    }).addTo(map);
                    markers.push(label);
                }


                markers.push(circle);
            });
        }

        function handleFlightSelection(flight) {
            if (selectedFlight && selectedFlight.id === flight.id) {
                resetCamera();
            } else {
                focusFlight(flight);
            }
        }

        function focusFlight(flight) {
            selectedFlight = flight;
            const start = airports[flight.from];
            const end = airports[flight.to];
            if (!start || !end) return;

            // Fit bounds
            const bounds = L.latLngBounds([start.lat, start.lng], [end.lat, end.lng]);
            map.fitBounds(bounds, { padding: [100, 100], maxZoom: 6, animate: true });

            updateMapVisuals();
            renderUI();

            // Scroll flight card
            setTimeout(() => {
                const active = document.querySelector('.flight-card.active');
                if (active) active.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 50);
        }

        // Shared helper: generate arc points (same curvature as route lines)
        function getArcPoints(start, end, numPoints = 100) {
            const points = [];
            for (let i = 0; i <= numPoints; i++) {
                const t = i / numPoints;
                const lat = start.lat + t * (end.lat - start.lat);
                let lngDiff = end.lng - start.lng;
                if (Math.abs(lngDiff) > 180) {
                    lngDiff = lngDiff > 0 ? lngDiff - 360 : lngDiff + 360;
                }
                const lng = start.lng + t * lngDiff;
                const curveFactor = Math.sin(t * Math.PI) * 0.15;
                const midLat = (start.lat + end.lat) / 2;
                const curveOffset = curveFactor * Math.abs(lngDiff) * (midLat > 0 ? 1 : -1) * 0.3;
                points.push([lat + curveOffset, lng]);
            }
            return points;
        }

        // Helper: interpolate position along arc points at a given progress (0-1)
        function interpolateArc(arcPoints, progress) {
            const idx = progress * (arcPoints.length - 1);
            const i = Math.floor(idx);
            const frac = idx - i;
            if (i >= arcPoints.length - 1) return arcPoints[arcPoints.length - 1];
            const p1 = arcPoints[i];
            const p2 = arcPoints[i + 1];
            return [
                p1[0] + (p2[0] - p1[0]) * frac,
                p1[1] + (p2[1] - p1[1]) * frac
            ];
        }

        // Helper: create glowing dot icon for animation
        function makeDotIcon(size = 12) {
            return L.divIcon({
                className: 'animated-dot',
                html: `<div style="width:${size}px;height:${size}px;border-radius:50%;background:#3B82F6;box-shadow:0 0 ${size}px ${size / 2}px rgba(59,130,246,0.6), 0 0 ${size * 2}px ${size}px rgba(59,130,246,0.3);"></div>`,
                iconSize: [size, size],
                iconAnchor: [size / 2, size / 2]
            });
        }

        // Trail polyline reference for cleanup
        let animatedTrail = null;

        function cleanupAnimation() {
            if (animatedPlane) {
                map.removeLayer(animatedPlane);
                animatedPlane = null;
            }
            if (animatedTrail) {
                map.removeLayer(animatedTrail);
                animatedTrail = null;
            }
            if (planeAnimationId) {
                cancelAnimationFrame(planeAnimationId);
                planeAnimationId = null;
            }
        }

        function animatePlaneOnRoute(start, end) {
            cleanupAnimation();

            const arcPoints = getArcPoints(start, end);

            // Create trail polyline (starts empty, grows as dot moves)
            animatedTrail = L.polyline([], {
                color: '#3B82F6',
                weight: 3,
                opacity: 0.8,
                dashArray: null
            }).addTo(map);

            // Create glowing dot
            animatedPlane = L.marker(arcPoints[0], { icon: makeDotIcon(12) }).addTo(map);

            const duration = 4000;
            let animationStart = performance.now();

            function animate(currentTime) {
                const elapsed = currentTime - animationStart;
                let progress = (elapsed % duration) / duration;

                // Reset trail on each new loop
                if (elapsed > 0 && (elapsed % duration) < 20) {
                    animatedTrail.setLatLngs([]);
                }

                const eased = progress < 0.5
                    ? 2 * progress * progress
                    : 1 - Math.pow(-2 * progress + 2, 2) / 2;

                const pos = interpolateArc(arcPoints, eased);
                animatedPlane.setLatLng(pos);

                // Build trail up to current position
                const trailIdx = Math.floor(eased * (arcPoints.length - 1));
                const trailPoints = arcPoints.slice(0, trailIdx + 1);
                trailPoints.push(pos);
                animatedTrail.setLatLngs(trailPoints);

                planeAnimationId = requestAnimationFrame(animate);
            }

            planeAnimationId = requestAnimationFrame(animate);
        }

        // Flight Playback Animation
        let isPlayingAnimation = false;
        let currentPlaybackIndex = 0;
        let playbackTimeoutId = null;

        function playAllFlightsAnimation() {
            if (isPlayingAnimation) {
                stopFlightPlayback();
                return;
            }

            const filtered = getFilteredFlights();
            if (filtered.length === 0) return;

            // Sort by date ascending
            const sorted = [...filtered].sort((a, b) => new Date(a.date) - new Date(b.date));

            isPlayingAnimation = true;
            currentPlaybackIndex = 0;

            // Update play button to stop icon
            const playBtn = document.getElementById('playAnimationBtn');
            if (playBtn) {
                playBtn.innerHTML = '<i class="ph-bold ph-stop text-lg"></i>';
            }

            // Show overlay
            showPlaybackOverlay();

            playNextFlight(sorted);
        }

        function playNextFlight(sortedFlights) {
            if (!isPlayingAnimation || currentPlaybackIndex >= sortedFlights.length) {
                stopFlightPlayback();
                return;
            }

            const flight = sortedFlights[currentPlaybackIndex];
            const from = airports[flight.from];
            const to = airports[flight.to];

            if (!from || !to) {
                currentPlaybackIndex++;
                playNextFlight(sortedFlights);
                return;
            }

            // Update overlay info
            updatePlaybackOverlay(flight, currentPlaybackIndex + 1, sortedFlights.length);

            // Zoom to route
            map.fitBounds([[from.lat, from.lng], [to.lat, to.lng]], { padding: [50, 50] });

            // Animate plane (one pass, not looping)
            animatePlaneOnePass(from, to, () => {
                currentPlaybackIndex++;
                playbackTimeoutId = setTimeout(() => playNextFlight(sortedFlights), 500);
            });
        }

        function animatePlaneOnePass(start, end, onComplete) {
            cleanupAnimation();

            const arcPoints = getArcPoints(start, end);

            // Create trail polyline
            animatedTrail = L.polyline([], {
                color: '#3B82F6',
                weight: 3,
                opacity: 0.8
            }).addTo(map);

            // Create glowing dot
            animatedPlane = L.marker(arcPoints[0], { icon: makeDotIcon(14) }).addTo(map);

            const duration = 3000;
            const animationStart = performance.now();

            function animate(currentTime) {
                if (!isPlayingAnimation) {
                    if (onComplete) onComplete();
                    return;
                }

                const elapsed = currentTime - animationStart;
                const progress = Math.min(elapsed / duration, 1);

                const eased = progress < 0.5
                    ? 2 * progress * progress
                    : 1 - Math.pow(-2 * progress + 2, 2) / 2;

                const pos = interpolateArc(arcPoints, eased);
                animatedPlane.setLatLng(pos);

                // Build trail up to current position
                const trailIdx = Math.floor(eased * (arcPoints.length - 1));
                const trailPoints = arcPoints.slice(0, trailIdx + 1);
                trailPoints.push(pos);
                animatedTrail.setLatLngs(trailPoints);

                if (progress < 1) {
                    planeAnimationId = requestAnimationFrame(animate);
                } else {
                    if (onComplete) onComplete();
                }
            }

            planeAnimationId = requestAnimationFrame(animate);
        }

        function stopFlightPlayback() {
            isPlayingAnimation = false;
            if (playbackTimeoutId) {
                clearTimeout(playbackTimeoutId);
                playbackTimeoutId = null;
            }
            cleanupAnimation();

            const playBtn = document.getElementById('playAnimationBtn');
            if (playBtn) {
                playBtn.innerHTML = '<i class="ph-bold ph-play text-lg"></i>';
            }

            hidePlaybackOverlay();
        }

        function showPlaybackOverlay() {
            let overlay = document.getElementById('playbackOverlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'playbackOverlay';
                overlay.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-[#1C1C1E]/95 backdrop-blur-md rounded-2xl px-6 py-3 shadow-2xl border border-[#2C2C2E] z-50';
                document.body.appendChild(overlay);
            }
            overlay.style.display = 'block';
        }

        function updatePlaybackOverlay(flight, current, total) {
            const overlay = document.getElementById('playbackOverlay');
            if (overlay) {
                overlay.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="text-white text-sm font-bold">${current}/${total}</div>
                        <div class="text-white">
                            <span class="font-bold">${flight.from}</span>
                            <span class="text-gray-400 mx-2">→</span>
                            <span class="font-bold">${flight.to}</span>
                        </div>
                        <div class="text-gray-400 text-xs">${flight.date}</div>
                    </div>
                `;
            }
        }

        function hidePlaybackOverlay() {
            const overlay = document.getElementById('playbackOverlay');
            if (overlay) overlay.style.display = 'none';
        }

        // ... existing code ...

        function resetCamera() {
            selectedFlight = null;
            map.setView([30, 0], 2, { animate: true });
            updateMapVisuals();
            renderUI(); // To unselect card
        }

        // Hover Handlers
        function hoverFlight(flight) {
            if (hoveredFlight && hoveredFlight.id === flight.id) return;
            hoveredFlight = flight;
            updateMapVisuals();
        }

        function unhoverFlight() {
            if (!hoveredFlight) return;
            hoveredFlight = null;
            updateMapVisuals();
        }

        // Shared Logic (Filtering, CSV Parsing, Stats)
        function processFlightData(results) {
            console.group("Data Processing");
            console.log("Raw Rows:", results.data.length);

            if (results.errors.length) console.warn("CSV Errors:", results.errors);

            let missingAirports = new Set();

            if (!results.data || results.data.length === 0) {
                console.warn("No flight data found.");
                flights = [];
            } else {
                flights = results.data.map((row, index) => {
                    // Extract IATA logic - Robustness
                    const extractIATA = (str) => {
                        if (!str) return null;
                        const match = str.match(/\(([A-Z]{3})\/[A-Z]{4}\)/);
                        if (match) return match[1];
                        const clean = str.trim().toUpperCase();
                        return clean.length === 3 ? clean : (clean.substring(0, 3));
                    };

                    const fromIATA = extractIATA(row.From);
                    const toIATA = extractIATA(row.To);

                    if (fromIATA && !airports[fromIATA]) missingAirports.add(fromIATA);
                    if (toIATA && !airports[toIATA]) missingAirports.add(toIATA);

                    // Robust Date Parsing
                    let year = 2024; // Default safe
                    let dateStr = row.Date;
                    if (dateStr) {
                        try {
                            if (dateStr.includes('/')) {
                                // DD/MM/YYYY
                                const parts = dateStr.split('/');
                                if (parts.length === 3) year = parseInt(parts[2]);
                            } else if (dateStr.includes('-')) {
                                // YYYY-MM-DD
                                const parts = dateStr.split('-');
                                if (parts[0].length === 4) year = parseInt(parts[0]);
                            }
                        } catch (e) { console.warn("Date parse error", dateStr); }
                    }

                    let distance = 0;
                    if (fromIATA && toIATA && airports[fromIATA] && airports[toIATA]) {
                        distance = calculateDistance(airports[fromIATA].lat, airports[fromIATA].lng, airports[toIATA].lat, airports[toIATA].lng);
                    }

                    const fromCountry = (airports[fromIATA] && airports[fromIATA].country) || "Unknown";
                    const toCountry = (airports[toIATA] && airports[toIATA].country) || "Unknown";
                    const isNational = (fromCountry === "ES" && toCountry === "ES");

                    return {
                        id: index,
                        date: row.Date,
                        year: year,
                        isNational: isNational,
                        from: fromIATA,
                        to: toIATA,
                        flightNumber: row["Flight number"] || "",
                        airline: row.Airline || "Unknown",
                        aircraft: row.Aircraft || "Unknown",
                        registration: row.Registration || "-",
                        seat: row["Seat number"] || "-",
                        duration: row.Duration || "0:00",
                        distance: distance,
                        // New fields from MyFlightRadar CSV
                        depTime: row["Dep time"] ? row["Dep time"].substring(0, 5) : null, // HH:MM
                        arrTime: row["Arr time"] ? row["Arr time"].substring(0, 5) : null, // HH:MM
                        seatType: parseInt(row["Seat type"]) || 0, // 1=Window, 2=Aisle, 3=Middle
                        flightClass: parseInt(row["Flight class"]) || 1, // 1=Economy, 2=Business, etc.
                        flightReason: parseInt(row["Flight reason"]) || 0, // 0=None, 1=Leisure, 2=Business
                        note: row.Note || null
                    };
                }).filter(f => f.from && f.to && airports[f.from] && airports[f.to]);
            }

            console.log("Processed Valid Flights:", flights.length);
            console.log("Missing Airports (Top 10):", [...missingAirports].slice(0, 10));
            console.groupEnd();

            if (missingAirports.size > 0) {
                // Optional: Show error/warning in UI if significant data loss
                if ((results.data.length - flights.length) > 5) {
                    console.warn(`Warning: Rejected ${results.data.length - flights.length} flights due to missing airport data.`);
                    // Could append to UI if requested, sticking to console for now as per "Debug" request.
                }
            }

            populateYearFilter();
            populateAdvancedFilters(); // Populate airline/aircraft/country filters
            updateMapVisuals();
            renderUI(true); // Animate on initial load
            calculateStats();
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            showLoading();
            Papa.parse(file, {
                header: true, skipEmptyLines: true, encoding: "ISO-8859-1",
                complete: function (results) { processFlightData(results); event.target.value = ''; },
                error: function (err) { showError("Error loading CSV"); }
            });
        }

        function showLoading() {
            listContainer.innerHTML = '<div class="p-4 text-white">Cargando...</div>';
        }
        function showError(msg) {
            listContainer.innerHTML = `<div class="p-4 text-red-500">${msg}</div>`;
        }

        // Filter variables
        let currentAirlineFilter = 'all';
        let currentAircraftFilter = 'all';
        let currentCountryFilter = 'all';
        let heatmapLayer = null;
        let searchQuery = '';
        let currentSortOrder = 'date-desc';

        function filterByYear(animate = false) {
            const select = document.getElementById('yearFilter');
            currentYearFilter = select.value;
            updateMapVisuals();
            renderUI(animate); // Only animate KPIs when animate is true
            calculateStats();
        }

        function getFilteredFlights() {
            let result = flights;

            if (currentYearFilter !== 'all') {
                result = result.filter(f => f.year.toString() === currentYearFilter);
            }
            if (currentAirlineFilter !== 'all') {
                result = result.filter(f => f.airline === currentAirlineFilter);
            }
            if (currentAircraftFilter !== 'all') {
                result = result.filter(f => f.aircraft === currentAircraftFilter);
            }
            if (currentCountryFilter !== 'all') {
                result = result.filter(f => {
                    const fromC = airports[f.from]?.country;
                    const toC = airports[f.to]?.country;
                    return fromC === currentCountryFilter || toC === currentCountryFilter;
                });
            }

            // Search query filter
            if (searchQuery.trim()) {
                const q = searchQuery.toLowerCase().trim();
                result = result.filter(f => {
                    return (f.airline && f.airline.toLowerCase().includes(q)) ||
                        (f.from && f.from.toLowerCase().includes(q)) ||
                        (f.to && f.to.toLowerCase().includes(q)) ||
                        (f.date && f.date.includes(q)) ||
                        (f.flightNumber && f.flightNumber.toLowerCase().includes(q)) ||
                        (f.note && f.note.toLowerCase().includes(q)) ||
                        (airports[f.from]?.city && airports[f.from].city.toLowerCase().includes(q)) ||
                        (airports[f.to]?.city && airports[f.to].city.toLowerCase().includes(q));
                });
            }

            return result;
        }

        function toggleFiltersPanel() {
            const panel = document.getElementById('filtersPanel');
            const arrow = document.getElementById('filterArrow');
            panel.classList.toggle('hidden');
            arrow.style.transform = panel.classList.contains('hidden') ? '' : 'rotate(180deg)';
        }

        function populateAdvancedFilters() {
            const airlines = [...new Set(flights.map(f => f.airline).filter(Boolean))].sort();
            const aircrafts = [...new Set(flights.map(f => f.aircraft).filter(Boolean))].sort();
            const countries = [...new Set(flights.flatMap(f => [airports[f.from]?.country, airports[f.to]?.country].filter(Boolean)))].sort();

            const airlineSelect = document.getElementById('airlineFilter');
            const aircraftSelect = document.getElementById('aircraftFilter');
            const countrySelect = document.getElementById('countryFilter');

            airlineSelect.innerHTML = '<option value="all">Todas las aerolíneas</option>' +
                airlines.map(a => `<option value="${a}">${a}</option>`).join('');
            aircraftSelect.innerHTML = '<option value="all">Todos los aviones</option>' +
                aircrafts.map(a => `<option value="${a}">${a}</option>`).join('');
            countrySelect.innerHTML = '<option value="all">Todos los países</option>' +
                countries.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        function applyAdvancedFilters() {
            currentAirlineFilter = document.getElementById('airlineFilter').value;
            currentAircraftFilter = document.getElementById('aircraftFilter').value;
            currentCountryFilter = document.getElementById('countryFilter').value;

            updateMapVisuals();
            renderUI(false);
            calculateStats();
        }

        function clearFilters() {
            // Reset advanced filters
            currentAirlineFilter = 'all';
            currentAircraftFilter = 'all';
            currentCountryFilter = 'all';
            document.getElementById('airlineFilter').value = 'all';
            document.getElementById('aircraftFilter').value = 'all';
            document.getElementById('countryFilter').value = 'all';

            // Also reset year filter
            currentYearFilter = 'all';
            document.getElementById('yearFilter').value = 'all';

            // Reset search and sort
            searchQuery = '';
            document.getElementById('searchInput').value = '';
            currentSortOrder = 'date-desc';
            document.getElementById('sortSelector').value = 'date-desc';

            updateMapVisuals();
            renderUI(true); // Animate KPIs since filters changed
            calculateStats();
        }

        function applySearch() {
            searchQuery = document.getElementById('searchInput').value;
            updateMapVisuals();
            renderUI(false);
            calculateStats();
        }

        function applySort() {
            currentSortOrder = document.getElementById('sortSelector').value;
            renderUI(false);
        }

        function toggleHeatmap() {
            if (heatmapLayer) {
                map.removeLayer(heatmapLayer);
                heatmapLayer = null;
            } else {
                const heatData = [];
                const filtered = getFilteredFlights();

                filtered.forEach(f => {
                    const from = airports[f.from];
                    const to = airports[f.to];
                    if (from) heatData.push([from.lat, from.lng, 0.5]);
                    if (to) heatData.push([to.lat, to.lng, 0.5]);
                });

                heatmapLayer = L.heatLayer(heatData, {
                    radius: 25,
                    blur: 15,
                    maxZoom: 10,
                    gradient: { 0.4: 'blue', 0.6: 'cyan', 0.7: 'lime', 0.8: 'yellow', 1: 'red' }
                }).addTo(map);
            }
        }

        function populateYearFilter() {
            const years = [...new Set(flights.map(f => f.year))].sort((a, b) => b - a);
            const select = document.getElementById('yearFilter');
            select.innerHTML = '<option value="all">Todos los años</option>';
            years.forEach(y => {
                const opt = document.createElement('option');
                opt.value = y;
                opt.innerText = y;
                select.appendChild(opt);
            });
        }

        // Chart instances (for cleanup)
        let chartYear, chartMonth, chartDay;

        function calculateStats() {
            const filtered = getFilteredFlights();
            const total = filtered.length;

            // Collect all data
            const airlines = {}, aircrafts = {}, airportCounts = {}, countries = {}, routes = {};
            const byYear = {}, byMonth = {}, byDay = {};
            const seatTypes = { 'Ventana': 0, 'Pasillo': 0, 'Centro': 0, 'Otro': 0 };
            const flightReasons = { 'Ocio': 0, 'Trabajo': 0, 'Sin especificar': 0 };
            let totalMinutes = 0;

            filtered.forEach(f => {
                if (f.airline) airlines[f.airline] = (airlines[f.airline] || 0) + 1;
                if (f.aircraft) aircrafts[f.aircraft] = (aircrafts[f.aircraft] || 0) + 1;

                // Airports
                if (f.from) airportCounts[f.from] = (airportCounts[f.from] || 0) + 1;
                if (f.to) airportCounts[f.to] = (airportCounts[f.to] || 0) + 1;

                // Countries
                const fromC = airports[f.from]?.country;
                const toC = airports[f.to]?.country;
                if (fromC) countries[fromC] = (countries[fromC] || 0) + 1;
                if (toC) countries[toC] = (countries[toC] || 0) + 1;

                // Routes
                const route = `${f.from}-${f.to}`;
                routes[route] = (routes[route] || 0) + 1;

                // Time
                if (f.duration) {
                    const [h, m] = f.duration.split(':').map(Number);
                    totalMinutes += (h || 0) * 60 + (m || 0);
                }

                // By Year
                if (f.year) byYear[f.year] = (byYear[f.year] || 0) + 1;

                // By Month
                if (f.date) {
                    const parts = f.date.includes('/') ? f.date.split('/') : f.date.split('-');
                    const monthIdx = f.date.includes('/') ? parseInt(parts[1]) - 1 : parseInt(parts[1]) - 1;
                    if (!isNaN(monthIdx)) byMonth[monthIdx] = (byMonth[monthIdx] || 0) + 1;

                    // Day of week
                    try {
                        const dateObj = f.date.includes('/')
                            ? new Date(parts[2], parts[1] - 1, parts[0])
                            : new Date(parts[0], parts[1] - 1, parts[2]);
                        const dow = dateObj.getDay();
                        byDay[dow] = (byDay[dow] || 0) + 1;
                    } catch (e) { }
                }

                // Seat type
                if (f.seatType === 1) seatTypes['Ventana']++;
                else if (f.seatType === 2) seatTypes['Pasillo']++;
                else if (f.seatType === 3) seatTypes['Centro']++;
                else seatTypes['Otro']++;

                // Flight reason
                if (f.flightReason === 1) flightReasons['Ocio']++;
                else if (f.flightReason === 2) flightReasons['Trabajo']++;
                else flightReasons['Sin especificar']++;
            });

            // Update KPIs
            document.getElementById('modalTotalFlights').textContent = total;
            const hours = Math.floor(totalMinutes / 60);
            const mins = totalMinutes % 60;
            document.getElementById('modalTotalTime').textContent = `${hours}h ${mins}m`;

            // Helper for bar rendering
            const renderBars = (data, color, max = 5) => {
                const sorted = Object.entries(data).sort((a, b) => b[1] - a[1]).slice(0, max);
                const maxVal = sorted[0]?.[1] || 1;
                return sorted.map(([name, count]) => `
                    <div class="flex items-center gap-2 text-xs">
                        <span class="w-16 text-gray-400 truncate">${name.split('(')[0].trim()}</span>
                        <div class="flex-1 h-1.5 bg-gray-800 rounded-full overflow-hidden">
                            <div class="h-full ${color} rounded-full" style="width: ${(count / maxVal) * 100}%"></div>
                        </div>
                        <span class="text-gray-500 font-mono w-6 text-right">${count}</span>
                    </div>
                `).join('');
            };

            document.getElementById('airlineStats').innerHTML = renderBars(airlines, 'bg-blue-500') || '<p class="text-xs text-gray-600">-</p>';
            document.getElementById('aircraftStats').innerHTML = renderBars(aircrafts, 'bg-emerald-500') || '<p class="text-xs text-gray-600">-</p>';
            document.getElementById('airportStats').innerHTML = renderBars(airportCounts, 'bg-purple-500') || '<p class="text-xs text-gray-600">-</p>';
            document.getElementById('countryStats').innerHTML = renderBars(countries, 'bg-orange-500') || '<p class="text-xs text-gray-600">-</p>';
            document.getElementById('routeStats').innerHTML = renderBars(routes, 'bg-pink-500') || '<p class="text-xs text-gray-600">-</p>';

            // New: Seat type and flight reason stats
            const filteredSeatTypes = Object.fromEntries(Object.entries(seatTypes).filter(([_, v]) => v > 0));
            const filteredReasons = Object.fromEntries(Object.entries(flightReasons).filter(([_, v]) => v > 0));
            document.getElementById('seatTypeStats').innerHTML = renderBars(filteredSeatTypes, 'bg-cyan-500', 4) || '<p class="text-xs text-gray-600">-</p>';
            document.getElementById('flightReasonStats').innerHTML = renderBars(filteredReasons, 'bg-amber-500', 3) || '<p class="text-xs text-gray-600">-</p>';

            // Charts
            const chartOpts = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { ticks: { color: '#9CA3AF', font: { size: 10 } }, grid: { display: false } },
                    y: { ticks: { color: '#9CA3AF', font: { size: 10 }, stepSize: 1 }, grid: { color: '#374151' } }
                }
            };

            // Destroy old charts
            if (chartYear) chartYear.destroy();
            if (chartMonth) chartMonth.destroy();
            if (chartDay) chartDay.destroy();

            // Year chart
            const sortedYears = Object.keys(byYear).sort();
            chartYear = new Chart(document.getElementById('chartYear'), {
                type: 'bar',
                data: {
                    labels: sortedYears,
                    datasets: [{ data: sortedYears.map(y => byYear[y]), backgroundColor: '#3B82F6', borderRadius: 4 }]
                },
                options: chartOpts
            });

            // Month chart
            const monthNames = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            chartMonth = new Chart(document.getElementById('chartMonth'), {
                type: 'bar',
                data: {
                    labels: monthNames,
                    datasets: [{ data: monthNames.map((_, i) => byMonth[i] || 0), backgroundColor: '#10B981', borderRadius: 4 }]
                },
                options: chartOpts
            });

            // Day of week chart
            const dayNames = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
            chartDay = new Chart(document.getElementById('chartDay'), {
                type: 'bar',
                data: {
                    labels: dayNames,
                    datasets: [{ data: dayNames.map((_, i) => byDay[i] || 0), backgroundColor: '#8B5CF6', borderRadius: 4 }]
                },
                options: chartOpts
            });
        }

        function renderUI(animate = false) {
            const filtered = getFilteredFlights();

            // Stats - only animate when filter changes
            if (animate) {
                const elFlights = document.getElementById('totalFlights');
                const startFlights = parseInt(elFlights.innerText.replace(/\D/g, '')) || 0;
                animateValue('totalFlights', startFlights, filtered.length, 800);
            } else {
                document.getElementById('totalFlights').innerText = filtered.length;
            }

            // List
            listContainer.innerHTML = '';

            // Sort flights based on currentSortOrder
            let displayFlights = [...filtered];
            const [sortField, sortDir] = currentSortOrder.split('-');

            displayFlights.sort((a, b) => {
                let comparison = 0;

                if (sortField === 'date') {
                    // Parse dates for comparison (format: YYYY-MM-DD or DD/MM/YYYY)
                    const parseDate = (d) => {
                        if (!d) return new Date(0);
                        if (d.includes('-')) {
                            const [y, m, day] = d.split('-');
                            return new Date(y, m - 1, day);
                        } else {
                            const [day, m, y] = d.split('/');
                            return new Date(y, m - 1, day);
                        }
                    };
                    comparison = parseDate(a.date) - parseDate(b.date);
                } else if (sortField === 'duration') {
                    // Duration format: HH:MM
                    const parseDuration = (d) => {
                        if (!d) return 0;
                        const [h, m] = d.split(':').map(Number);
                        return (h || 0) * 60 + (m || 0);
                    };
                    comparison = parseDuration(a.duration) - parseDuration(b.duration);
                } else if (sortField === 'distance') {
                    comparison = (a.distance || 0) - (b.distance || 0);
                }

                return sortDir === 'desc' ? -comparison : comparison;
            });

            displayFlights.forEach(f => {
                const card = document.createElement('div');
                const isActive = selectedFlight && selectedFlight.id === f.id;
                card.className = `flight-card bg-[#1C1C1E] border border-[#2C2C2E] rounded-2xl p-4 mb-3 cursor-pointer text-white group ${isActive ? 'active' : ''}`;
                card.onclick = () => handleFlightSelection(f);
                card.onmouseenter = () => hoverFlight(f);
                card.onmouseleave = () => unhoverFlight();

                const iata = f.airline.substring(0, 2).toUpperCase();
                const flightIATA = f.flightNumber.length >= 2 ? f.flightNumber.substring(0, 2).toUpperCase() : 'XX';

                // Customized Tags
                const tagStyle = f.isNational
                    ? 'background-color: rgba(86, 74, 222, 0.2); color: rgb(86, 74, 222); border: 1px solid rgba(86, 74, 222, 0.5);'
                    : 'background-color: rgba(0, 129, 152, 0.2); color: rgb(0, 129, 152); border: 1px solid rgba(0, 129, 152, 0.5);';

                // Time Format (Helvetica, Hh Mm)
                let timeStr = f.duration;
                if (f.duration.includes(':')) {
                    const [h, m] = f.duration.split(':').map(Number);
                    timeStr = `${h}h ${m}m`;
                }

                // Calculate CO₂ for this flight
                const dist = f.distance || 0;
                let co2Factor = dist < 1500 ? 0.255 : (dist < 4000 ? 0.195 : 0.150);
                const flightCO2 = Math.round(dist * co2Factor);

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center gap-2">
                             <div class="bg-white p-1 rounded-lg shadow-sm">
                                <img src="logos/${flightIATA}.png" 
                                     class="w-8 h-8 object-contain" 
                                     alt="${f.airline}"
                                     onerror="this.onerror=null; this.src='https://pics.avs.io/200/200/${flightIATA}.png';">
                             </div>
                             <div>
                                <div class="font-bold text-sm leading-none">${f.airline.split('(')[0]}</div>
                                <div class="text-[10px] text-gray-500 font-mono mt-0.5">${f.date}</div>
                             </div>
                        </div>
                        <div class="flex gap-1 items-center flex-wrap">
                            ${f.flightReason === 1 ? '<span class="text-[8px] px-1 py-px rounded-full font-semibold uppercase" style="background-color: rgba(52, 199, 89, 0.15); color: rgb(52, 199, 89);">Ocio</span>' : ''}
                            ${f.flightReason === 2 ? '<span class="text-[8px] px-1 py-px rounded-full font-semibold uppercase" style="background-color: rgba(142, 142, 147, 0.15); color: rgb(142, 142, 147);">Trabajo</span>' : ''}
                            <span class="text-[8px] px-1 py-px rounded-full font-medium" style="color: rgb(255, 149, 0);">${flightCO2}kg</span>
                            <span class="text-[8px] px-1 py-px rounded-full font-semibold" style="color: ${f.isNational ? 'rgb(86, 74, 222)' : 'rgb(0, 129, 152)'};">
                                ${f.isNational ? 'DOM' : 'INT'}
                            </span>
                        </div>
                    </div>
                    
                    <div class="relative flex items-center justify-between mb-4 px-2">
                        <!-- Connecting Line -->
                        <div class="absolute top-1/2 left-10 right-10 h-px bg-gradient-to-r from-transparent via-gray-700 to-transparent -z-1"></div>
                        
                        <div class="text-center z-10 pr-2">
                            <div class="text-2xl font-black">${f.from}</div>
                            ${f.depTime ? `<div class="text-[10px] text-gray-500 font-mono">${f.depTime}</div>` : ''}
                        </div>
                        
                        <!-- Animated Plane -->
                        <div class="absolute top-0 bottom-0 left-10 right-10 pointer-events-none overflow-hidden">
                             <i class="ph-fill ph-airplane fly-icon text-lg text-blue-500"></i>
                        </div>
                        
                        <div class="flex flex-col items-center z-10 px-2 mt-8"> 
                            <span class="text-[10px] text-gray-400 px-1.5 rounded font-bold" style="font-family: 'Helvetica', 'Arial', sans-serif;">${timeStr}</span>
                        </div>
                        
                        <div class="text-center z-10 pl-2">
                            <div class="text-2xl font-black">${f.to}</div>
                            ${f.arrTime ? `<div class="text-[10px] text-gray-500 font-mono">${f.arrTime}</div>` : ''}
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-y-1 gap-x-4 text-[10px] text-gray-500 border-t border-[#2C2C2E] pt-3">
                         <div class="flex justify-between"><span>Vuelo</span> <span class="text-gray-300 font-mono">${f.flightNumber}</span></div>
                         <div class="flex justify-between"><span>Avión</span> <span class="text-gray-300">${f.aircraft.split('(')[0]}</span></div>
                         <div class="flex justify-between"><span>Asiento</span> <span class="text-gray-300 font-mono">${f.seat}${f.seatType === 1 ? ' (V)' : f.seatType === 2 ? ' (P)' : f.seatType === 3 ? ' (C)' : ''}</span></div>
                         <div class="flex justify-between"><span>Matrícula</span> <span class="text-gray-300 font-mono">${f.registration}</span></div>
                    </div>
                    ${f.note ? `<div class="mt-2 pt-2 border-t border-[#2C2C2E] text-[10px] text-gray-400 flex items-start gap-1.5"><span class="text-gray-500 font-semibold">Nota:</span><span class="italic">"${f.note}"</span></div>` : ''}
                 `;
                listContainer.appendChild(card);
            });

            // Recalculate basic stats for display
            let totalDist = filtered.reduce((acc, f) => acc + f.distance, 0);
            let totalTimeMin = filtered.reduce((acc, f) => {
                const [h, m] = f.duration.split(':').map(Number);
                return acc + (h || 0) * 60 + (m || 0);
            }, 0);

            // Calculate CO₂ emissions (kg per passenger)
            // Emission factors: short-haul ~0.255, medium ~0.195, long ~0.150 kg/km
            let totalCO2 = filtered.reduce((acc, f) => {
                const dist = f.distance || 0;
                let factor;
                if (dist < 1500) factor = 0.255;      // Short-haul
                else if (dist < 4000) factor = 0.195; // Medium-haul
                else factor = 0.150;                   // Long-haul
                return acc + (dist * factor);
            }, 0);

            animateValue('totalHours', 0, Math.floor(totalTimeMin / 60), 800, 'h');
            animateValue('totalDistance', 0, Math.floor(totalDist), 800, ' km');
            animateValue('totalCO2', 0, Math.floor(totalCO2), 800, ' kg');
        }

        function toggleStats() {
            const modal = document.getElementById('statsModal');
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden', 'pointer-events-none', 'opacity-0');
                // Recalculate stats after modal animation to fix Chart.js render
                setTimeout(() => calculateStats(), 100);
            } else {
                modal.classList.add('hidden', 'pointer-events-none', 'opacity-0');
            }
        }

        function toggleTheme() {
            const body = document.body;
            const icon = document.getElementById('themeIcon');

            if (body.classList.contains('light')) {
                body.classList.remove('light');
                icon.classList.remove('ph-sun');
                icon.classList.add('ph-moon');
                localStorage.setItem('theme', 'dark');
            } else {
                body.classList.add('light');
                icon.classList.remove('ph-moon');
                icon.classList.add('ph-sun');
                localStorage.setItem('theme', 'light');
            }

            // Update map tiles if needed
            if (map) updateMapVisuals();
        }

        // Initialize theme on load
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const icon = document.getElementById('themeIcon');

            if (savedTheme === 'light') {
                document.body.classList.add('light');
                if (icon) {
                    icon.classList.remove('ph-moon');
                    icon.classList.add('ph-sun');
                }
            }
        }

        async function exportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });

            const filtered = getFilteredFlights();
            const totalDist = filtered.reduce((sum, f) => sum + (f.distance || 0), 0);
            let totalMin = 0;
            filtered.forEach(f => {
                if (f.duration) {
                    const [h, m] = f.duration.split(':').map(Number);
                    totalMin += (h || 0) * 60 + (m || 0);
                }
            });

            // Calculate total CO₂
            const totalCO2 = filtered.reduce((sum, f) => {
                const dist = f.distance || 0;
                const factor = dist < 1500 ? 0.255 : (dist < 4000 ? 0.195 : 0.150);
                return sum + (dist * factor);
            }, 0);

            // Colors
            const darkBg = [28, 28, 30];
            const white = [255, 255, 255];
            const gray = [156, 163, 175];
            const accent = [59, 130, 246];
            const orange = [255, 149, 0];

            // Background
            doc.setFillColor(...darkBg);
            doc.rect(0, 0, 210, 297, 'F');

            // Header
            doc.setTextColor(...white);
            doc.setFontSize(28);
            doc.setFont('helvetica', 'bold');
            doc.text('Historial de Vuelos', 20, 30);

            doc.setTextColor(...gray);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text(`Marc's Flight History • ${new Date().toLocaleDateString('es-ES')}`, 20, 40);

            // KPIs (4 boxes)
            const kpiWidth = 40;
            const kpiX = [20, 65, 110, 155];

            kpiX.forEach(x => {
                doc.setFillColor(44, 44, 46);
                doc.roundedRect(x, 50, kpiWidth, 30, 3, 3, 'F');
            });

            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(...white);
            doc.text(String(filtered.length), kpiX[0] + kpiWidth / 2, 65, { align: 'center' });
            doc.text(`${Math.floor(totalMin / 60)}h`, kpiX[1] + kpiWidth / 2, 65, { align: 'center' });
            doc.text(`${Math.round(totalDist / 1000)}k`, kpiX[2] + kpiWidth / 2, 65, { align: 'center' });
            doc.setTextColor(...orange);
            doc.text(`${Math.round(totalCO2)}`, kpiX[3] + kpiWidth / 2, 65, { align: 'center' });

            doc.setTextColor(...gray);
            doc.setFontSize(8);
            doc.text('VUELOS', kpiX[0] + kpiWidth / 2, 74, { align: 'center' });
            doc.text('HORAS', kpiX[1] + kpiWidth / 2, 74, { align: 'center' });
            doc.text('KM', kpiX[2] + kpiWidth / 2, 74, { align: 'center' });
            doc.text('CO₂ kg', kpiX[3] + kpiWidth / 2, 74, { align: 'center' });

            // Flight List Header
            doc.setFillColor(...accent);
            doc.roundedRect(20, 90, 170, 8, 2, 2, 'F');
            doc.setTextColor(...white);
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.text('FECHA', 25, 96);
            doc.text('RUTA', 52, 96);
            doc.text('AEROLÍNEA', 95, 96);
            doc.text('DURACIÓN', 140, 96);
            doc.text('CO₂', 175, 96);

            // Flight list
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            let y = 105;
            const maxFlights = Math.min(filtered.length, 35);

            for (let i = 0; i < maxFlights; i++) {
                const f = filtered[i];
                if (y > 280) break;

                // Calculate CO₂ for this flight
                const fDist = f.distance || 0;
                const fFactor = fDist < 1500 ? 0.255 : (fDist < 4000 ? 0.195 : 0.150);
                const fCO2 = Math.round(fDist * fFactor);

                doc.setTextColor(...gray);
                doc.text(f.date || '-', 25, y);
                doc.setTextColor(...white);
                doc.text(`${f.from} → ${f.to}`, 52, y);
                doc.setTextColor(...gray);
                doc.text((f.airline || '-').split('(')[0].substring(0, 12), 95, y);
                doc.text(f.duration || '-', 140, y);
                doc.setTextColor(...orange);
                doc.text(`${fCO2}`, 175, y);
                y += 5.5;
            }

            if (filtered.length > maxFlights) {
                doc.setTextColor(...gray);
                doc.setFontSize(10);
                doc.text(`... y ${filtered.length - maxFlights} vuelos más`, 105, y + 5, { align: 'center' });
            }

            // Footer
            doc.setTextColor(100, 100, 100);
            doc.setFontSize(8);
            doc.text('Generado con Flight History App', 105, 290, { align: 'center' });

            // Save
            doc.save(`Historial_Vuelos_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        function animateValue(id, start, end, duration, suffix = "") {
            const obj = document.getElementById(id);
            if (!obj) return;
            if (isNaN(start)) start = 0;

            // Set color based on direction (green = increase, red = decrease)
            const isIncreasing = end > start;
            const isDecreasing = end < start;
            if (isIncreasing) {
                obj.style.color = '#34C759'; // Green
            } else if (isDecreasing) {
                obj.style.color = '#FF3B30'; // Red
            }

            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                const val = Math.floor(progress * (end - start) + start);

                let displayVal = val;
                if (id === 'totalDistance' && val > 10000) {
                    displayVal = (val / 1000).toFixed(1) + "k";
                    obj.innerHTML = displayVal + suffix.replace(" km", " km");
                } else {
                    obj.innerHTML = val + suffix;
                }

                if (progress < 1) {
                    window.requestAnimationFrame(step);
                } else {
                    // Reset color to white after animation completes
                    obj.style.color = '';
                }
            };
            window.requestAnimationFrame(step);
        }
    </script>
</body>

</html>